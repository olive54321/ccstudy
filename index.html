<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>å£è¯­ç»ƒä¹ </title>
  <style>
    body{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Arial,sans-serif;max-width:900px;margin:28px auto;padding:18px;background:#fafafa;color:#111}
    #app{display:none}
    .card{background:#fff;border:1px solid #eee;border-radius:14px;padding:16px;box-shadow:0 2px 10px rgba(0,0,0,.04);margin-bottom:14px}
    h1{margin:0 0 6px 0;text-align:center}
    .sub{margin:0 0 14px 0;text-align:center;color:#666;font-size:14px}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    select,button,input{border:1px solid #ccc;border-radius:10px;padding:9px 12px;font-size:14px;background:#fff}
    button{cursor:pointer}
    button:hover{background:#f3f3f3}
    .muted{color:#666;font-size:13px}
    #english{font-size:20px;font-weight:700;line-height:1.35}
    #chinese{margin-top:8px;color:#444}
    .pill{display:inline-block;background:#f1f1f1;border-radius:999px;padding:4px 10px;font-size:12px;color:#444}
    .progressWrap{width:100%;height:10px;background:#eee;border-radius:999px;overflow:hidden}
    .progressBar{height:10px;background:#111;width:0%}
    .grid2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    @media (max-width:720px){ .grid2{grid-template-columns:1fr} }
    .list{max-height:220px;overflow:auto;border:1px solid #eee;border-radius:12px;padding:8px;background:#fff}
    .item{padding:8px;border-radius:10px;border:1px solid #eee;margin:6px 0;display:flex;gap:10px;align-items:flex-start;justify-content:space-between}
    .item button{padding:6px 10px;border-radius:10px}
    .tiny{font-size:12px;color:#666}
    .ok{color:#0a7}.warn{color:#b60}.bad{color:#c33}
    code{background:#f4f4f4;padding:2px 6px;border-radius:6px}
  </style>
</head>
<body>
<script>
(function () {
  const PASSWORD = "lucia";
  const input = (prompt("Enter password:") || "").trim();

  if (input !== PASSWORD) {
    window.__AUTH_OK__ = false;
    document.body.innerHTML = `
      <div style="text-align:center;margin-top:80px;font-family:sans-serif">
        <h2>Access denied</h2>
      </div>`;
    return;
  }

  window.__AUTH_OK__ = true;

  // âœ… ç­‰ #app å‡ºç°åå†æ˜¾ç¤º
  window.addEventListener("DOMContentLoaded", () => {
    const app = document.getElementById("app");
    if (app) app.style.display = "block";
  });
})();
</script>
<div id="app">
  <h1>English Speaking Practice</h1>
  <div class="sub">ä¸Šä¸€å¥ / ä¸‹ä¸€å¥ / éšæœº Â· è¿›åº¦æ¡ Â· æ”¶è— Â· é”™é¢˜æœ¬ï¼ˆè‡ªåŠ¨ï¼‰</div>

  <div class="card">
    <div class="row" style="justify-content:space-between;">
      <div class="row">
        <span class="pill">Topic</span>
        <select id="scene">
          <option value="daily">Daily</option>
          <option value="travel">Travel</option>
          <option value="sweet">Sweet</option>
          <option value="shopping">Shopping</option>
          <option value="housing">Housing</option>
          <option value="dining">Dining</option>
          <option value="study">Study</option>
        </select>

        <span class="pill">Mode</span>
        <select id="mode">
          <option value="all">All</option>
          <option value="wrong">Wrong-book</option>
          <option value="fav">Favorites</option>
        </select>

        <span class="pill">ä½äºè¯¥åˆ†è¿›é”™é¢˜</span>
        <input id="threshold" type="number" min="0" max="100" step="1" value="70" style="width:90px" />
      </div>

      <div class="row">
        <button id="btnReset">Reset progress</button>
      </div>
    </div>

    <div style="margin-top:12px" class="progressWrap">
      <div id="progressBar" class="progressBar"></div>
    </div>
    <div style="margin-top:8px" class="row">
      <div id="progressText" class="muted">Loadingâ€¦</div>
      <div id="statusPill" class="pill">Ready</div>
    </div>
  </div>

  <div class="card">
    <div id="english">Loadingâ€¦</div>
    <div id="chinese"></div>

    <div class="row" style="margin-top:12px;">
      <button id="btnPrev">â—€ Previous</button>
      <button id="btnNext">Next â–¶</button>
      <button id="btnRandom">ğŸ² Random</button>
      <button id="btnSpeak">ğŸ”Š Read</button>
      <button id="btnRecord">ğŸ¤ Speak</button>
      <button id="btnFav">â­ Favorite</button>
      <button id="btnWrong">ğŸ“ Toggle Wrong</button>
    </div>

    <div style="margin-top:10px" class="muted">
      å»ºè®®ç”¨ Chromeï¼›éº¦å…‹é£æ²¡ååº”å°±æ£€æŸ¥ç½‘ç«™æƒé™ã€‚
    </div>
  </div>

  <div class="grid2">
    <div class="card">
      <div class="pill">Recognized</div>
      <div id="result" style="margin-top:10px;">Recognized text will appear here.</div>
      <div style="margin-top:10px" class="pill">Score</div>
      <div id="score" style="margin-top:10px;">Score will appear here.</div>
      <div id="log" class="muted" style="margin-top:10px;"></div>
    </div>

    <div class="card">
      <div class="row" style="justify-content:space-between;">
        <div class="pill">Lists</div>
        <div class="tiny">ç‚¹å‡» Go å¯è·³è½¬</div>
      </div>

      <div class="row" style="margin-top:10px;">
        <button id="tabFav">â­ Favorites</button>
        <button id="tabWrong">ğŸ“ Wrong-book</button>
      </div>

      <div id="listTitle" class="muted" style="margin-top:10px;">Favorites</div>
      <div id="listBox" class="list"></div>
    </div>
  </div>

<script>
  if (window.__AUTH_OK__ !== true) {
  throw new Error("Unauthorized");
}

function k(topic, name){ return `spk_${topic}_${name}`; }
const $ = (id)=>document.getElementById(id);

let topic = "daily";
let mode = "all";
let threshold = 70;

let fullList = [];
let activeList = [];
let index = -1;

let favorites = new Set();
let wrongs = new Set();

let listTab = "fav";

function sentenceId(s){ return (s.en || "").trim().toLowerCase().slice(0,80); }
function clamp(n, a, b){ return Math.max(a, Math.min(b, n)); }
function setStatus(text){ $("statusPill").textContent = text; }

function saveState(){
  localStorage.setItem(k(topic,"index"), String(index));
  localStorage.setItem(k(topic,"favorites"), JSON.stringify([...favorites]));
  localStorage.setItem(k(topic,"wrongs"), JSON.stringify([...wrongs]));
  localStorage.setItem(k(topic,"threshold"), String(threshold));
  localStorage.setItem(k(topic,"mode"), mode);
}

function loadState(){
  try{
    const idx = parseInt(localStorage.getItem(k(topic,"index")) ?? "-1", 10);
    index = Number.isFinite(idx) ? idx : -1;

    favorites = new Set(JSON.parse(localStorage.getItem(k(topic,"favorites")) ?? "[]"));
    wrongs = new Set(JSON.parse(localStorage.getItem(k(topic,"wrongs")) ?? "[]"));

    threshold = parseInt(localStorage.getItem(k(topic,"threshold")) ?? "70", 10);
    threshold = clamp(threshold, 0, 100);
    $("threshold").value = threshold;

    mode = localStorage.getItem(k(topic,"mode")) ?? "all";
    $("mode").value = mode;
  }catch{
    index = -1; favorites = new Set(); wrongs = new Set(); threshold = 70; mode = "all";
  }
}

function rebuildActiveList(){
  if(mode === "all") activeList = fullList;
  else if(mode === "fav") activeList = fullList.filter(s => favorites.has(sentenceId(s)));
  else if(mode === "wrong") activeList = fullList.filter(s => wrongs.has(sentenceId(s)));
  else activeList = fullList;
}

function updateProgress(){
  const total = activeList.length || 0;
  const pos = total ? (index + 1) : 0;
  $("progressText").textContent = `Topic: ${topic} Â· Mode: ${mode} Â· ${pos}/${total}`;
  $("progressBar").style.width = (total ? (pos/total*100) : 0) + "%";
}

function updateFavWrongButtons(){
  if(!activeList.length) return;
  const id = sentenceId(activeList[index]);
  $("btnFav").textContent = favorites.has(id) ? "â­ Favorited" : "â­ Favorite";
  $("btnWrong").textContent = wrongs.has(id) ? "ğŸ“ In Wrong-book" : "ğŸ“ Toggle Wrong";
}

function showCurrent(){
  if(!activeList.length){
    $("english").textContent = "No sentences in this mode.";
    $("chinese").textContent = "åˆ‡æ¢ Mode å› All è¯•è¯•ã€‚";
    updateProgress();
    return;
  }
  index = clamp(index, 0, activeList.length - 1);
  const s = activeList[index];
  $("english").textContent = s.en || "(empty)";
  $("chinese").textContent = s.zh ? ("ä¸­æ–‡ï¼š " + s.zh) : "";
  $("result").textContent = "Recognized text will appear here.";
  $("score").textContent = "Score will appear here.";
  $("log").textContent = "";
  updateFavWrongButtons();
  updateProgress();
  saveState();
}

function cleanWords(s){
  return (s || "").toLowerCase().replace(/[^a-z\s]/g,"").split(/\s+/).filter(Boolean);
}
function calcSimilarity(spoken, target){
  if(!spoken || !target) return 0;
  const sWords = cleanWords(spoken);
  const tWords = cleanWords(target);
  if(!sWords.length || !tWords.length) return 0;

  let score = 0;
  const maxScore = tWords.length * 2;
  let ti = 0;
  for(const w of sWords){
    if(ti < tWords.length && w === tWords[ti]){ score += 2; ti++; }
    else if(tWords.includes(w)) score += 1;
  }
  const ratio = sWords.length / tWords.length;
  if(ratio < 0.75) score *= ratio;
  return Math.round(Math.min(100, (score / maxScore) * 100));
}

function renderList(){
  const box = $("listBox");
  box.innerHTML = "";
  const ids = listTab === "fav" ? [...favorites] : [...wrongs];
  $("listTitle").textContent = listTab === "fav" ? "Favorites" : "Wrong-book";

  if(!ids.length){
    const div = document.createElement("div");
    div.className = "muted";
    div.textContent = listTab === "fav" ? "No favorites yet." : "No wrong sentences yet.";
    box.appendChild(div);
    return;
  }

  const map = new Map(fullList.map(s => [sentenceId(s), s.en]));
  ids.forEach((id) => {
    const en = map.get(id) || id;

    const row = document.createElement("div");
    row.className = "item";

    const left = document.createElement("div");
    left.style.flex = "1";
    left.innerHTML = `<div>${en}</div><div class="tiny">id: <code>${id}</code></div>`;

    const right = document.createElement("div");
    right.style.display = "flex";
    right.style.gap = "8px";

    const btnGo = document.createElement("button");
    btnGo.textContent = "Go";
    btnGo.onclick = () => {
      mode = "all"; $("mode").value = "all";
      rebuildActiveList();
      const idx = fullList.findIndex(s => sentenceId(s) === id);
      index = idx >= 0 ? idx : 0;
      showCurrent();
      renderList();
    };

    const btnRm = document.createElement("button");
    btnRm.textContent = "Remove";
    btnRm.onclick = () => {
      if(listTab === "fav") favorites.delete(id);
      else wrongs.delete(id);
      saveState();
      rebuildActiveList();
      if(index >= activeList.length) index = activeList.length - 1;
      renderList();
      updateFavWrongButtons();
      updateProgress();
    };

    right.appendChild(btnGo);
    right.appendChild(btnRm);
    row.appendChild(left);
    row.appendChild(right);
    box.appendChild(row);
  });
}

async function loadTopic(t){
  topic = t;
  setStatus("Loadingâ€¦");
  $("english").textContent = "Loadingâ€¦";
  $("log").textContent = "";

  // å…³é”®ï¼šç”¨ ./data å¹¶ä¸”å¤±è´¥å°±æ˜¾ç¤ºåŸå› 
  const resp = await fetch(`./data/${topic}.json`, { cache:"no-cache" });
  if (!resp.ok) {
    const msg = `Fetch failed: ${resp.status} ${resp.statusText} (./data/${topic}.json)`;
    $("english").textContent = msg;
    $("log").textContent = msg;
    setStatus("Error");
    throw new Error(msg);
  }

  const json = await resp.json();
  fullList = (json || []).map(s => ({ en: (s.en||"").trim(), zh: (s.zh||"").trim() }));

  loadState();
  rebuildActiveList();

  if(activeList.length){
    if(index === -1) index = 0;
    showCurrent();
  }else{
    $("english").textContent = "No sentences in this mode yet.";
    $("chinese").textContent = "Try switching Mode back to All.";
    updateProgress();
  }

  renderList();
  setStatus("Ready");
}

$("scene").onchange = () => loadTopic($("scene").value).catch(()=>{});
$("mode").onchange = () => { mode = $("mode").value; rebuildActiveList(); if(index>=activeList.length) index = 0; showCurrent(); renderList(); saveState(); };
$("threshold").onchange = () => { threshold = clamp(parseInt($("threshold").value||"70",10),0,100); $("threshold").value = threshold; saveState(); };
$("btnReset").onclick = () => { if(confirm("Reset progress for this topic?")) { index = 0; saveState(); showCurrent(); } };

$("btnPrev").onclick = () => { if(!activeList.length) return; index = clamp(index-1,0,activeList.length-1); showCurrent(); };
$("btnNext").onclick = () => { if(!activeList.length) return; index = clamp(index+1,0,activeList.length-1); showCurrent(); };
$("btnRandom").onclick = () => { if(!activeList.length) return; index = Math.floor(Math.random()*activeList.length); showCurrent(); };

$("btnSpeak").onclick = () => {
  if(!activeList.length) return;
  const u = new SpeechSynthesisUtterance(activeList[index].en);
  u.lang = "en-US";
  speechSynthesis.speak(u);
};

$("btnFav").onclick = () => {
  if(!activeList.length) return;
  const id = sentenceId(activeList[index]);
  favorites.has(id) ? favorites.delete(id) : favorites.add(id);
  saveState(); rebuildActiveList(); updateFavWrongButtons(); renderList();
};

$("btnWrong").onclick = () => {
  if(!activeList.length) return;
  const id = sentenceId(activeList[index]);
  wrongs.has(id) ? wrongs.delete(id) : wrongs.add(id);
  saveState(); rebuildActiveList(); updateFavWrongButtons(); renderList();
};

$("tabFav").onclick = () => { listTab="fav"; renderList(); };
$("tabWrong").onclick = () => { listTab="wrong"; renderList(); };

$("btnRecord").onclick = () => {
  if(!activeList.length) return;
  const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
  if(!SR){ $("log").textContent = "SpeechRecognition not supported. Please use Chrome."; return; }
  const rec = new SR();
  rec.lang = "en-US"; rec.interimResults = false; rec.maxAlternatives = 1;
  setStatus("Listeningâ€¦");
  $("log").textContent = "Listeningâ€¦";
  rec.start();

  rec.onresult = (e) => {
    const spoken = e.results[0][0].transcript;
    const target = activeList[index].en;
    $("result").textContent = "You said: " + spoken;

    const sc = calcSimilarity(spoken, target);
    let cls="warn", msg="ğŸ™‚ Keep refining";
    if(sc>=90){cls="ok";msg="ğŸŒŸ Excellent";}
    else if(sc>=75){cls="ok";msg="ğŸ‘ Very good";}
    else if(sc<60){cls="bad";msg="ğŸ’ª Practice more";}
    $("score").innerHTML = `Similarity: <b class="${cls}">${sc}%</b> â€” ${msg}`;

    const id = sentenceId(activeList[index]);
    if(sc < threshold){ wrongs.add(id); $("log").textContent = `Added to Wrong-book (score < ${threshold}).`; }
    else { $("log").textContent = "Nice! Not added to Wrong-book."; }

    saveState(); updateFavWrongButtons(); renderList(); setStatus("Ready");
  };

  rec.onerror = (e) => { $("log").textContent = "Error: " + e.error; setStatus("Error"); };
  rec.onend = () => { setStatus("Ready"); };
};

window.addEventListener("DOMContentLoaded", () => {
  $("scene").value = "daily";
  loadTopic("daily").catch(()=>{});
});
</script>
</div>
</body>
</html>
